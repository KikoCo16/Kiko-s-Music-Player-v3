<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PCgram - Messagerie</title>
    
    <link rel="manifest" href='data:application/json,{"name":"PCgram","short_name":"PCgram","start_url":".","display":"standalone","background_color":"#e7ebf0","theme_color":"#0088cc","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2111/2111646.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},{"src":"https://cdn-icons-png.flaticon.com/512/2111/2111646.png","sizes":"512x512","type":"image/png"}]}'>
    
    <style>
        :root { --tg-blue: #0088cc; --tg-bg: #e7ebf0; --sent: #effdde; --danger: #ff4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--tg-bg); height: 100vh; overflow: hidden; }

        /* Interface */
        .header { background: var(--tg-blue); color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #fff; border: 1px solid #ddd; }
        
        .contact-list { flex: 1; overflow-y: auto; background: white; }
        .contact-item { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; }
        .contact-info { flex: 1; font-weight: 500; cursor: pointer; }
        .contact-actions { display: flex; gap: 15px; }
        .action-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; }
        .contact-item.blocked { background: #fff1f1; }
        .contact-item.blocked .contact-info { color: #999; }

        #view-list, #view-chat { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; transition: transform 0.3s; }
        .hidden { display: none !important; }
        
        /* Chat */
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #e7ebf0; }
        .msg { max-width: 85%; padding: 8px 12px; border-radius: 15px; font-size: 15px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }
        .msg img, .msg video { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        .sent { align-self: flex-end; background: var(--sent); border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: white; border-bottom-left-radius: 4px; }

        /* Input */
        .input-area { background: white; border-top: 1px solid #ddd; padding: 8px; }
        .input-row { display: flex; align-items: center; gap: 8px; }
        input[type="text"] { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 16px; }
        .media-btns { display: flex; justify-content: space-around; padding-top: 8px; border-top: 1px solid #f5f5f5; margin-top: 8px; }
        .btn-text { background: none; border: none; color: var(--tg-blue); font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="view-list">
        <div class="header">
            <label for="profile-upload"><img id="my-avatar" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png"></label>
            <input type="file" id="profile-upload" class="hidden" accept="image/*" onchange="updateProfilePic(this)">
            <span style="font-weight: bold;">PCgram</span>
            <button class="btn-text" style="color:white; font-size:24px;" onclick="addNewContact()">+</button>
        </div>
        <div id="contact-list" class="contact-list"></div>
    </div>

    <div id="view-chat" class="hidden">
        <div class="header">
            <button onclick="backToList()" style="color:white; background:none; border:none; font-size:24px; cursor:pointer;">‚Üê</button>
            <div style="flex:1; margin-left:10px; display:flex; align-items:center; gap:10px;">
                <img id="chat-avatar" class="avatar" src="">
                <span id="chat-title" style="font-weight: bold;">Chat</span>
            </div>
        </div>
        <div id="messages"></div>
        <div id="blocked-banner" class="hidden" style="padding: 15px; text-align: center; color: var(--danger); background: #fff; font-weight: bold;">Contact bloqu√©</div>
        <div class="input-area" id="input-controls">
            <div class="input-row">
                <input type="text" id="msgInput" placeholder="Message...">
                <button class="btn-text" onclick="sendMessage()">ENVOYER</button>
            </div>
            <div class="media-btns">
                <label for="media-upload" style="font-size:22px; cursor:pointer;">üñºÔ∏è</label>
                <input type="file" id="media-upload" class="hidden" accept="image/*,video/*" onchange="sendMedia(this)">
                <button class="btn-text" style="font-size:14px;">üé¨ GIF</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- SERVICE WORKER INLINE ---
    const swCode = `self.addEventListener('fetch', function(e){})`;
    const swBlob = new Blob([swCode], {type: 'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(swUrl).catch(err => console.log("SW error", err));
    }

    // --- CONFIGURATION FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCUOaafijAqzEofCgiJHwhscYCg997dlQI",
        authDomain: "pcgram-65fca.firebaseapp.com",
        projectId: "pcgram-65fca",
        storageBucket: "pcgram-65fca.appspot.com",
        messagingSenderId: "625488249988",
        appId: "1:625488249988:web:8a9ab961b92d8a80e7aed1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let monId = localStorage.getItem('pcgram_user');
    let targetId = null;
    let unsubMessages = null;
    let isInitialLoad = true;

    // --- FONCTION DE PERMISSION ---
    async function requestNotificationPermission() {
        if ("Notification" in window) {
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
                console.log("Permission de notification refus√©e");
            }
        }
    }

    // --- INITIALISATION (MISE √Ä JOUR) ---
    async function init() {
        // Demande des notifications d√®s le d√©part
        await requestNotificationPermission();

        if (!monId) {
            let user = prompt("Choisissez votre ID unique :");
            if (user) {
                monId = user.trim().toLowerCase();
                await setDoc(doc(db, "users", monId), { 
                    avatar: "https://cdn-icons-png.flaticon.com/512/149/149071.png" 
                });
                localStorage.setItem('pcgram_user', monId);
            } else {
                return init();
            }
        }

        const snap = await getDoc(doc(db, "users", monId));
        if(snap.exists()) {
            document.getElementById('my-avatar').src = snap.data().avatar;
        }
        
        renderContacts();
    }

    // --- GESTION CONTACTS ---
    window.addNewContact = async () => {
        const id = prompt("Entrez l'ID du contact √† ajouter :");
        if (!id) return;
        const cleanId = id.trim().toLowerCase();
        if(cleanId === monId) return alert("C'est votre propre ID !");
        
        const snap = await getDoc(doc(db, "users", cleanId));
        if (snap.exists()) {
            let contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
            if (!contacts.includes(cleanId)) {
                contacts.push(cleanId);
                localStorage.setItem('contacts', JSON.stringify(contacts));
                renderContacts();
            }
        } else alert("Cet utilisateur n'existe pas.");
    };

    window.confirmDelete = (id) => {
        if(confirm(`Supprimer ${id} de votre liste ?`)) {
            let contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
            contacts = contacts.filter(c => c !== id);
            localStorage.setItem('contacts', JSON.stringify(contacts));
            renderContacts();
        }
    };

    window.confirmBlock = (id) => {
        let blocked = JSON.parse(localStorage.getItem('blocked') || '[]');
        const isBlocked = blocked.includes(id);
        if(confirm(`${isBlocked ? 'D√©bloquer' : 'Bloquer'} ${id} ?`)) {
            if(isBlocked) blocked = blocked.filter(b => b !== id);
            else blocked.push(id);
            localStorage.setItem('blocked', JSON.stringify(blocked));
            renderContacts();
        }
    };

    window.renderContacts = async () => {
        const list = document.getElementById('contact-list');
        const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
        const blocked = JSON.parse(localStorage.getItem('blocked') || '[]');
        list.innerHTML = contacts.length === 0 ? "<div style='padding:40px;text-align:center;color:#999;'>Aucun contact.<br>Cliquez sur + pour en ajouter.</div>" : "";

        for (const id of contacts) {
            const snap = await getDoc(doc(db, "users", id));
            if(!snap.exists()) continue;
            const data = snap.data();
            const isBlocked = blocked.includes(id);

            const div = document.createElement('div');
            div.className = `contact-item ${isBlocked ? 'blocked' : ''}`;
            div.innerHTML = `
                <img src="${data.avatar}" class="avatar">
                <div class="contact-info" onclick="openChat('${id}', '${data.avatar}', ${isBlocked})">
                    <div style="font-size:16px;">${id}</div>
                    ${isBlocked ? '<small style="color:red">Bloqu√©</small>' : '<small style="color:gray">En ligne</small>'}
                </div>
                <div class="contact-actions">
                    <button class="action-btn" onclick="confirmBlock('${id}')">${isBlocked ? '‚úÖ' : 'üö´'}</button>
                    <button class="action-btn" onclick="confirmDelete('${id}')">üóëÔ∏è</button>
                </div>
            `;
            list.appendChild(div);
        }
    };

    // --- GESTION MESSAGERIE ---
    window.openChat = (id, avatar, isBlocked) => {
        targetId = id;
        isInitialLoad = true; // Reset le flag pour le nouveau chat
        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('view-chat').classList.remove('hidden');
        document.getElementById('chat-title').innerText = id;
        document.getElementById('chat-avatar').src = avatar;

        document.getElementById('input-controls').classList.toggle('hidden', isBlocked);
        document.getElementById('blocked-banner').classList.toggle('hidden', !isBlocked);
        listenMessages();
    };

    window.backToList = () => {
        if (unsubMessages) unsubMessages();
        document.getElementById('view-chat').classList.add('hidden');
        document.getElementById('view-list').classList.remove('hidden');
    };

    window.sendMessage = async () => {
        const inp = document.getElementById('msgInput');
        if (!inp.value.trim()) return;
        await addDoc(collection(db, "messages"), { 
            sender: monId, 
            receiver: targetId, 
            text: inp.value, 
            timestamp: Date.now() 
        });
        inp.value = "";
    };

    window.sendMedia = (el) => {
        if (!el.files[0]) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const type = el.files[0].type.startsWith('image') ? 'img' : 'video';
            await addDoc(collection(db, "messages"), { 
                sender: monId, 
                receiver: targetId, 
                media: e.target.result, 
                type: type, 
                timestamp: Date.now() 
            });
        };
        reader.readAsDataURL(el.files[0]);
    };

    window.updateProfilePic = (el) => {
        if (!el.files[0]) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            await updateDoc(doc(db, "users", monId), { avatar: e.target.result });
            document.getElementById('my-avatar').src = e.target.result;
        };
        reader.readAsDataURL(el.files[0]);
    };

    function listenMessages() {
        if (unsubMessages) unsubMessages();
        const q = query(collection(db, "messages"), orderBy("timestamp", "asc"));
        
        unsubMessages = onSnapshot(q, (snapshot) => {
            const blocked = JSON.parse(localStorage.getItem('blocked') || '[]');
            const box = document.getElementById('messages');
            box.innerHTML = "";
            
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const d = change.doc.data();
                    
                    // Notifier si nouveau message re√ßu (pas par moi, pas bloqu√©, pas au premier chargement)
                    if (!isInitialLoad && d.sender !== monId && d.receiver === monId && !blocked.includes(d.sender)) {
                        if (targetId !== d.sender || document.hidden) {
                            new Notification(`PCgram : ${d.sender}`, {
                                body: d.text || "üì∑ M√©dia re√ßu",
                                icon: "https://cdn-icons-png.flaticon.com/512/2111/2111646.png"
                            });
                        }
                    }
                }
            });

            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                if (!blocked.includes(d.sender) && ((d.sender === monId && d.receiver === targetId) || (d.sender === targetId && d.receiver === monId))) {
                    const div = document.createElement('div');
                    div.className = `msg ${d.sender === monId ? 'sent' : 'received'}`;
                    
                    if (d.text) {
                        const txtNode = document.createElement('div');
                        txtNode.innerText = d.text;
                        div.appendChild(txtNode);
                    }
                    if (d.media) {
                        const m = document.createElement(d.type === 'img' ? 'img' : 'video');
                        m.src = d.media; 
                        if(d.type === 'video') m.controls = true;
                        div.appendChild(m);
                    }
                    box.appendChild(div);
                }
            });

            isInitialLoad = false;
            box.scrollTop = box.scrollHeight;
        });
    }

    init();
</script>

</body>
</html>
